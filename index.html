<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>MARIO-TOKENS - World Builder</title>
<style>
:root { --bg:#1a1a2e; --surface:#16213e; --accent:#e94560; --gold:#f5c542; --green:#43b581; --text:#eee; }
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--bg);color:var(--text);font-family:'Courier New',monospace;overflow-x:hidden;}

/* Header */
.header{background:var(--surface);padding:0.8rem 1rem;display:flex;align-items:center;justify-content:space-between;border-bottom:2px solid var(--accent);}
.logo{font-size:1.3rem;font-weight:bold;}
.logo span{color:var(--gold);}
.stats{display:flex;gap:1.5rem;font-size:0.85rem;}
.stat-val{color:var(--gold);font-weight:bold;}

/* Toolbar */
.toolbar{background:#0f3460;padding:0.5rem;display:flex;gap:0.3rem;flex-wrap:wrap;justify-content:center;border-bottom:2px solid #1a1a3e;}
.tool-btn{
  width:40px;height:40px;border:2px solid #2a2a5e;border-radius:6px;
  background:#1a1a3e;cursor:pointer;font-size:1.3rem;display:flex;
  align-items:center;justify-content:center;transition:all 0.15s;
}
.tool-btn:hover{border-color:var(--gold);transform:scale(1.1);}
.tool-btn.active{border-color:var(--gold);background:#2a2a5e;box-shadow:0 0 8px rgba(245,197,66,0.4);}

/* Canvas area */
.canvas-wrap{display:flex;justify-content:center;padding:1rem;background:#0a0a1a;}
#world-canvas{
  border:2px solid #333;cursor:crosshair;
  image-rendering:pixelated;
  background:#87ceeb;
}

/* Controls */
.controls{background:var(--surface);padding:0.8rem;display:flex;gap:0.5rem;justify-content:center;flex-wrap:wrap;border-top:2px solid #1a1a3e;}
.ctrl-btn{
  background:var(--accent);color:#fff;border:none;padding:0.5rem 1rem;
  border-radius:6px;cursor:pointer;font-family:inherit;font-weight:bold;
  font-size:0.8rem;transition:all 0.2s;
}
.ctrl-btn:hover{opacity:0.85;transform:scale(1.03);}
.ctrl-btn.green{background:var(--green);}
.ctrl-btn.gold{background:var(--gold);color:#000;}

/* Token panel */
.token-panel{
  background:var(--surface);padding:1rem;margin:1rem auto;max-width:800px;
  border-radius:10px;border:1px solid #2a2a5e;
}
.token-panel h2{font-size:1.1rem;color:var(--gold);margin-bottom:0.5rem;}
.token-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:0.5rem;}
.token-card{
  background:#1a1a3e;border:1px solid #2a2a5e;border-radius:6px;
  padding:0.5rem;text-align:center;font-size:0.75rem;
  transition:all 0.2s;cursor:pointer;
}
.token-card:hover{border-color:var(--gold);transform:translateY(-2px);}
.token-emoji{font-size:1.5rem;}
.token-name{font-weight:bold;margin-top:0.2rem;}
.token-val{color:var(--gold);font-size:0.7rem;}

/* Mint animation */
@keyframes mint-flash{0%{opacity:0;transform:scale(0.5);}50%{opacity:1;transform:scale(1.2);}100%{opacity:1;transform:scale(1);}}
.minted{animation:mint-flash 0.5s ease-out;}

.footer{text-align:center;padding:1rem;font-size:0.7rem;color:#666;}
.footer a{color:var(--accent);}
</style>
</head>
<body>

<div class="header">
  <div class="logo"><span>MARIO</span>-TOKENS</div>
  <div class="stats">
    <div>Coins: <span class="stat-val" id="coins">0</span></div>
    <div>Tokens: <span class="stat-val" id="token-count">0</span></div>
    <div>World: <span class="stat-val" id="world-size">0</span> blocks</div>
  </div>
</div>

<div class="toolbar" id="toolbar"></div>

<div class="canvas-wrap">
  <canvas id="world-canvas" width="800" height="400"></canvas>
</div>

<div class="controls">
  <button class="ctrl-btn" onclick="clearWorld()">Clear</button>
  <button class="ctrl-btn" onclick="fillGround()">Ground Fill</button>
  <button class="ctrl-btn green" onclick="testPlay()">Play Test</button>
  <button class="ctrl-btn gold" onclick="mintToken()">Mint Token</button>
  <button class="ctrl-btn" onclick="exportWorld()">Export JSON</button>
  <button class="ctrl-btn" onclick="loadRandom()">Random World</button>
</div>

<div class="token-panel">
  <h2>Minted Tokens</h2>
  <div class="token-grid" id="token-grid"></div>
</div>

<div class="footer">
  MARIO-TOKENS World Builder | Part of <a href="https://pewpi-infinity.github.io/infinity-crown-index/">Infinity Crown Index</a> |
  <a href="https://pewpi-infinity.github.io/infinity-spark-market/">Buy on Marketplace</a>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TILE DEFINITIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const TILES = [
  { id:"air",    emoji:"",    color:"#87ceeb", name:"Air",      solid:false },
  { id:"brick",  emoji:"ğŸ§±", color:"#8B4513", name:"Brick",    solid:true },
  { id:"ground", emoji:"ğŸŸ«", color:"#654321", name:"Ground",   solid:true },
  { id:"coin",   emoji:"ğŸª™", color:"#FFD700", name:"Coin",     solid:false },
  { id:"block",  emoji:"â“", color:"#DAA520", name:"? Block",  solid:true },
  { id:"pipe",   emoji:"ğŸŸ©", color:"#228B22", name:"Pipe",     solid:true },
  { id:"star",   emoji:"â­", color:"#FFD700", name:"Star",     solid:false },
  { id:"mush",   emoji:"ğŸ„", color:"#FF6347", name:"Mushroom", solid:false },
  { id:"flag",   emoji:"ğŸš©", color:"#FF4444", name:"Flag",     solid:false },
  { id:"cloud",  emoji:"â˜ï¸", color:"#FFFFFF", name:"Cloud",    solid:false },
  { id:"water",  emoji:"ğŸŒŠ", color:"#1E90FF", name:"Water",    solid:false },
  { id:"lava",   emoji:"ğŸ”¥", color:"#FF4500", name:"Lava",     solid:false },
  { id:"crown",  emoji:"ğŸ‘‘", color:"#FFD700", name:"Crown",    solid:false },
  { id:"gem",    emoji:"ğŸ’", color:"#00CED1", name:"Gem",      solid:false },
  { id:"key",    emoji:"ğŸ”‘", color:"#DAA520", name:"Key",      solid:false },
  { id:"door",   emoji:"ğŸšª", color:"#8B4513", name:"Door",     solid:true },
  { id:"spike",  emoji:"â¬†ï¸", color:"#888",    name:"Spike",    solid:true },
  { id:"spring", emoji:"ğŸ”º", color:"#FF6B6B", name:"Spring",   solid:true },
];

const COLS = 50;
const ROWS = 25;
const TILE_SIZE = 16;
const canvas = document.getElementById("world-canvas");
const ctx = canvas.getContext("2d");
canvas.width = COLS * TILE_SIZE;
canvas.height = ROWS * TILE_SIZE;

let world = Array.from({length:ROWS}, () => Array(COLS).fill(0));
let selectedTile = 1; // brick
let coins = 0;
let tokens = [];
let isDrawing = false;

// Player state for test mode
let player = { x:2, y:ROWS-3, vx:0, vy:0, grounded:false };
let playMode = false;
let animFrame = null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOOLBAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildToolbar() {
  const tb = document.getElementById("toolbar");
  tb.innerHTML = TILES.map((t, i) =>
    `<button class="tool-btn${i===selectedTile?' active':''}" onclick="selectTile(${i})" title="${t.name}">${t.emoji||'.'}</button>`
  ).join("");
}

function selectTile(idx) {
  selectedTile = idx;
  buildToolbar();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DRAWING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function drawWorld() {
  // Sky gradient
  const grad = ctx.createLinearGradient(0,0,0,canvas.height);
  grad.addColorStop(0, "#4A90D9");
  grad.addColorStop(1, "#87CEEB");
  ctx.fillStyle = grad;
  ctx.fillRect(0,0,canvas.width,canvas.height);

  let blockCount = 0;
  for (let r=0; r<ROWS; r++) {
    for (let c=0; c<COLS; c++) {
      const tid = world[r][c];
      if (tid === 0) continue;
      blockCount++;
      const tile = TILES[tid];
      const x = c*TILE_SIZE, y = r*TILE_SIZE;

      // Fill color
      ctx.fillStyle = tile.color;
      ctx.fillRect(x, y, TILE_SIZE, TILE_SIZE);

      // Border
      ctx.strokeStyle = "rgba(0,0,0,0.3)";
      ctx.strokeRect(x, y, TILE_SIZE, TILE_SIZE);

      // Emoji (small)
      if (tile.emoji) {
        ctx.font = `${TILE_SIZE-2}px serif`;
        ctx.fillText(tile.emoji, x+1, y+TILE_SIZE-2);
      }
    }
  }

  // Draw player in test mode
  if (playMode) {
    ctx.fillStyle = "#FF0000";
    ctx.fillRect(player.x*TILE_SIZE, player.y*TILE_SIZE, TILE_SIZE, TILE_SIZE*1.2);
    ctx.font = `${TILE_SIZE}px serif`;
    ctx.fillText("ğŸƒ", player.x*TILE_SIZE, (player.y+1)*TILE_SIZE);
  }

  // Grid lines (subtle)
  ctx.strokeStyle = "rgba(255,255,255,0.05)";
  for (let r=0; r<=ROWS; r++) { ctx.beginPath(); ctx.moveTo(0,r*TILE_SIZE); ctx.lineTo(canvas.width,r*TILE_SIZE); ctx.stroke(); }
  for (let c=0; c<=COLS; c++) { ctx.beginPath(); ctx.moveTo(c*TILE_SIZE,0); ctx.lineTo(c*TILE_SIZE,canvas.height); ctx.stroke(); }

  document.getElementById("world-size").textContent = blockCount;
}

// Mouse handlers
canvas.addEventListener("mousedown", e => { isDrawing = true; placeTile(e); });
canvas.addEventListener("mousemove", e => { if (isDrawing) placeTile(e); });
canvas.addEventListener("mouseup", () => isDrawing = false);
canvas.addEventListener("mouseleave", () => isDrawing = false);

// Touch support
canvas.addEventListener("touchstart", e => { e.preventDefault(); isDrawing=true; placeTile(e.touches[0]); });
canvas.addEventListener("touchmove", e => { e.preventDefault(); if(isDrawing) placeTile(e.touches[0]); });
canvas.addEventListener("touchend", () => isDrawing = false);

function placeTile(e) {
  if (playMode) return;
  const rect = canvas.getBoundingClientRect();
  const scaleX = canvas.width / rect.width;
  const scaleY = canvas.height / rect.height;
  const c = Math.floor((e.clientX - rect.left) * scaleX / TILE_SIZE);
  const r = Math.floor((e.clientY - rect.top) * scaleY / TILE_SIZE);
  if (r>=0 && r<ROWS && c>=0 && c<COLS) {
    world[r][c] = selectedTile;
    drawWorld();
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WORLD ACTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function clearWorld() {
  world = Array.from({length:ROWS}, () => Array(COLS).fill(0));
  drawWorld();
}

function fillGround() {
  for (let c=0; c<COLS; c++) {
    world[ROWS-1][c] = 2; // ground
    world[ROWS-2][c] = 2;
  }
  drawWorld();
}

function loadRandom() {
  clearWorld();
  fillGround();

  // Random platforms
  for (let i=0; i<15; i++) {
    const w = 3 + Math.floor(Math.random()*5);
    const c = Math.floor(Math.random()*(COLS-w));
    const r = 5 + Math.floor(Math.random()*(ROWS-10));
    for (let j=0; j<w; j++) {
      world[r][c+j] = Math.random()>0.3 ? 1 : 4; // brick or ? block
    }
  }

  // Random coins
  for (let i=0; i<20; i++) {
    const c = Math.floor(Math.random()*COLS);
    const r = Math.floor(Math.random()*(ROWS-3));
    world[r][c] = 3; // coin
  }

  // Pipes
  for (let i=0; i<4; i++) {
    const c = 5 + Math.floor(Math.random()*(COLS-10));
    const h = 2 + Math.floor(Math.random()*3);
    for (let j=0; j<h; j++) {
      world[ROWS-3-j][c] = 5;
      world[ROWS-3-j][c+1] = 5;
    }
  }

  // Special items
  const specials = [6,7,12,13,14]; // star, mush, crown, gem, key
  for (let i=0; i<5; i++) {
    const c = Math.floor(Math.random()*COLS);
    const r = Math.floor(Math.random()*(ROWS-5));
    world[r][c] = specials[Math.floor(Math.random()*specials.length)];
  }

  // Flag at end
  world[ROWS-4][COLS-3] = 8;

  drawWorld();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PLAY TEST (simple physics)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const keys = {};
document.addEventListener("keydown", e => { keys[e.key]=true; e.preventDefault(); });
document.addEventListener("keyup", e => { keys[e.key]=false; });

function testPlay() {
  if (playMode) {
    playMode = false;
    cancelAnimationFrame(animFrame);
    drawWorld();
    return;
  }
  playMode = true;
  player = { x:2, y:ROWS-4, vx:0, vy:0, grounded:false };
  gameLoop();
}

function isSolid(c, r) {
  if (r<0||r>=ROWS||c<0||c>=COLS) return r>=ROWS;
  return TILES[world[r][c]]?.solid;
}

function gameLoop() {
  if (!playMode) return;

  // Input
  if (keys["ArrowLeft"]||keys["a"]) player.vx = -0.15;
  else if (keys["ArrowRight"]||keys["d"]) player.vx = 0.15;
  else player.vx *= 0.8;

  if ((keys["ArrowUp"]||keys["w"]||keys[" "]) && player.grounded) {
    player.vy = -0.35;
    player.grounded = false;
  }

  // Gravity
  player.vy += 0.015;

  // Move X
  player.x += player.vx;
  const px = Math.floor(player.x), py = Math.floor(player.y);
  if (isSolid(Math.floor(player.x+0.8), py) || isSolid(Math.floor(player.x+0.8), py+1)) {
    player.x = Math.floor(player.x+0.8) - 0.8;
    player.vx = 0;
  }
  if (isSolid(Math.floor(player.x), py) || isSolid(Math.floor(player.x), py+1)) {
    player.x = Math.ceil(player.x);
    player.vx = 0;
  }

  // Move Y
  player.y += player.vy;
  player.grounded = false;
  if (player.vy > 0 && (isSolid(Math.floor(player.x), Math.floor(player.y+1.2)) || isSolid(Math.floor(player.x+0.8), Math.floor(player.y+1.2)))) {
    player.y = Math.floor(player.y+1.2) - 1.2;
    player.vy = 0;
    player.grounded = true;
  }
  if (player.vy < 0 && (isSolid(Math.floor(player.x), Math.floor(player.y)) || isSolid(Math.floor(player.x+0.8), Math.floor(player.y)))) {
    player.y = Math.ceil(player.y);
    player.vy = 0;
  }

  // Collect coins
  const cr = Math.floor(player.y+0.5), cc = Math.floor(player.x+0.4);
  if (cr>=0&&cr<ROWS&&cc>=0&&cc<COLS) {
    const tid = world[cr][cc];
    if (tid===3) { world[cr][cc]=0; coins+=1; } // coin
    if (tid===6) { world[cr][cc]=0; coins+=5; } // star
    if (tid===12){ world[cr][cc]=0; coins+=10;} // crown
    if (tid===13){ world[cr][cc]=0; coins+=3; } // gem
    document.getElementById("coins").textContent = coins;
  }

  // Wrap/bounds
  if (player.x < 0) player.x = 0;
  if (player.x > COLS-1) player.x = COLS-1;
  if (player.y > ROWS+2) { player.y = ROWS-4; player.x = 2; } // respawn

  drawWorld();
  animFrame = requestAnimationFrame(gameLoop);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOKEN MINTING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function mintToken() {
  // Count blocks by type
  const counts = {};
  let total = 0;
  for (let r=0; r<ROWS; r++) {
    for (let c=0; c<COLS; c++) {
      if (world[r][c] > 0) {
        const t = TILES[world[r][c]];
        counts[t.name] = (counts[t.name]||0) + 1;
        total++;
      }
    }
  }

  if (total < 5) { alert("Place at least 5 blocks to mint!"); return; }

  // Calculate value based on diversity and size
  const diversity = Object.keys(counts).length;
  const value = Math.floor(total * diversity * 0.5) + coins;

  // Generate token
  const token = {
    id: `MT-${Date.now().toString(36).toUpperCase()}`,
    name: `World #${tokens.length+1}`,
    blocks: total,
    types: diversity,
    value: value,
    coins: coins,
    composition: counts,
    timestamp: new Date().toISOString(),
    emoji: Object.keys(counts).length > 5 ? "ğŸ‘‘" : Object.keys(counts).length > 3 ? "ğŸ’" : "ğŸª™",
  };

  tokens.push(token);
  document.getElementById("token-count").textContent = tokens.length;

  // Render token card
  const grid = document.getElementById("token-grid");
  const card = document.createElement("div");
  card.className = "token-card minted";
  card.innerHTML = `
    <div class="token-emoji">${token.emoji}</div>
    <div class="token-name">${token.name}</div>
    <div class="token-val">${token.value} value | ${token.blocks} blocks</div>
  `;
  card.onclick = () => alert(JSON.stringify(token, null, 2));
  grid.appendChild(card);
}

function exportWorld() {
  const data = {
    version: 1,
    cols: COLS,
    rows: ROWS,
    world: world,
    coins: coins,
    tokens: tokens,
    exported: new Date().toISOString(),
  };
  const blob = new Blob([JSON.stringify(data, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `mario-world-${Date.now()}.json`;
  a.click();
  URL.revokeObjectURL(url);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
buildToolbar();
fillGround();
drawWorld();
</script>
</body>
</html>
